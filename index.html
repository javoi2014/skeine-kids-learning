<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Skeine Kids Learning</title>
  <meta name="theme-color" content="#4f46e5" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <style>
    :root{
      --card: rgba(255,255,255,.72);
      --shadow: 0 18px 40px rgba(0,0,0,.12);
      --r: 20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      min-height:100vh;
      background: linear-gradient(180deg,#c7d2fe,#fbcfe8);
      color:#0f172a;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .wrap{width:min(980px,100%)}
    .card{
      background:var(--card);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .title{font-size:26px; font-weight:900; letter-spacing:-.02em}
    .sub{opacity:.75}
    .grid{display:grid; gap:12px}
    .grid2{grid-template-columns: repeat(2, minmax(0,1fr))}
    .grid4{grid-template-columns: repeat(4, minmax(0,1fr))}
    @media (max-width:720px){ .grid4{grid-template-columns: repeat(2, minmax(0,1fr))} }
    button{
      border:0;
      border-radius: 18px;
      padding:14px 14px;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      background:#111827;
      color:white;
      font-size:18px;
    }
    button.secondary{background: rgba(255,255,255,.7); color:#111827}
    button.big{height:76px; font-size:22px}
    button.choice{height:70px; font-size:20px; background:#111827}
    .pill{
      border-radius: 999px;
      padding:8px 10px;
      background: rgba(255,255,255,.55);
      font-weight:700;
    }
    .bar{display:flex; gap:10px; align-items:center}
    .mascot{
      width:56px; height:56px; border-radius:18px;
      background: rgba(255,255,255,.78);
      display:flex; align-items:center; justify-content:center;
      font-size:30px; box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .stars span{font-size:22px; margin-right:3px}
    .panel{background: rgba(255,255,255,.55); border-radius:18px; padding:14px}
    .prompt{font-size:20px; font-weight:900}
    .tiny{font-size:12px; opacity:.75}
    .center{text-align:center}
    .hidden{display:none}
    .dots{display:flex; flex-wrap:wrap; gap:10px}
    .dot{width:22px; height:22px; border-radius:999px; background: rgba(255,255,255,.95); box-shadow: 0 8px 18px rgba(0,0,0,.10)}
    .toast{
      margin-top:12px;
      padding:12px;
      border-radius: 18px;
      font-weight:900;
      text-align:center;
      background: rgba(16,185,129,.25);
    }
    .toast.bad{background: rgba(245,158,11,.25)}
    .confetti{
      pointer-events:none;
      position:fixed; inset:0;
      overflow:hidden;
    }
    .confetti i{
      position:absolute;
      width:10px; height:10px;
      background: rgba(255,255,255,.9);
      border-radius: 2px;
      left:50%; top:50%;
      animation: fly .9s ease-out forwards;
    }
    @keyframes fly{
      from{transform: translate(0,0) rotate(0deg); opacity:0}
      to{transform: translate(var(--x), var(--y)) rotate(260deg); opacity:1}
    }
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.40);
      display:flex; align-items:center; justify-content:center;
      padding:14px;
      z-index:50;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="app" class="card"></div>
  </div>

  <div id="confetti" class="confetti hidden"></div>

<script>
/* =======================
   Skeine Kids Learning (PWA)
   Phone-testable, no build tools
   ======================= */

const MODES = ["Shapes","Colors","Numbers","Letters","Phonics","Memory","Math","Story"];
const SHAPES = ["Circle","Square","Triangle","Star","Heart"];
const COLORS = ["Red","Blue","Green","Yellow","Purple","Orange"];
const NUMBERS = [1,2,3,4,5,6,7,8,9];
const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const PHONICS = [
  {letter:"A",sound:"ah"},{letter:"B",sound:"buh"},{letter:"C",sound:"kuh"},{letter:"D",sound:"duh"},
  {letter:"E",sound:"eh"},{letter:"F",sound:"fuh"},{letter:"G",sound:"guh"},{letter:"H",sound:"huh"},
  {letter:"I",sound:"ih"},{letter:"J",sound:"juh"},{letter:"K",sound:"kuh"},{letter:"L",sound:"luh"},
  {letter:"M",sound:"muh"},{letter:"N",sound:"nuh"},{letter:"O",sound:"oh"},{letter:"P",sound:"puh"},
  {letter:"R",sound:"ruh"},{letter:"S",sound:"sss"},{letter:"T",sound:"tuh"}
];
const STORY = [
  { title:"Sunny Park", text:"Jayce and Jayde go to the park. They see a red ball!", q:{type:"color",prompt:"Tap the RED thing",answer:"Red"} },
  { title:"Shape Picnic", text:"A friendly puppy brings snacks on a STAR plate.", q:{type:"shape",prompt:"Tap the STAR",answer:"Star"} },
  { title:"Counting Ducks", text:"They see ducks in the pond. Let‚Äôs count!", q:{type:"number",prompt:"Tap the number 3",answer:3} },
];

const LS_KEY = "skeine_kids_pwa_v1";
const app = document.getElementById("app");

const state = {
  screen: "welcome", // welcome|player|mode|game|winner
  player: null, // Jayce|Jayde
  mode: "Shapes",
  round: 1,
  score: 0,
  stars: 0,
  difficulty: 1, // 1..3 adaptive
  streak: 0,
  storyIndex: 0,
  voiceOn: true,
  feedback: null, // {ok,msg}
  progress: loadProgress()
};

function loadProgress(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) throw 0;
    return JSON.parse(raw);
  }catch{
    return {
      totalGames: 0,
      bestStreak: 0,
      totalStars: 0,
      difficulty: 1,
      modeWins: Object.fromEntries(MODES.map(m=>[m,0]))
    };
  }
}
function saveProgress(){
  localStorage.setItem(LS_KEY, JSON.stringify(state.progress));
}

function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function rand(n){ return Math.floor(Math.random()*n); }
function pick(arr){ return arr[rand(arr.length)]; }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ---- Sound (no files) ---- */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(AC) audioCtx = new AC();
  }
}
function beep(freq=440, dur=.09, gain=.05){
  ensureAudio();
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type="sine";
  o.frequency.value=freq;
  g.gain.value=gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + dur);
}
const SFX = {
  pop(){beep(520,.06,.04)},
  success(){beep(660,.07,.05); setTimeout(()=>beep(880,.08,.05),80)},
  fail(){beep(220,.12,.05)}
};

/* ---- Voice ---- */
function speak(text){
  if(!state.voiceOn) return;
  if(!window.speechSynthesis) return;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = .95; u.pitch = 1.1; u.volume = 1;
    window.speechSynthesis.speak(u);
  }catch{}
}

/* ---- Question Builder ---- */
function buildOptions(type, answer, difficulty){
  const optionCount = (difficulty===1)?4:(difficulty===2)?6:8;
  const pool =
    type==="shape"?SHAPES:
    type==="color"?COLORS:
    type==="number"?NUMBERS:
    type==="letter"?LETTERS:
    type==="phonics"?PHONICS.map(p=>p.letter):[];

  const set = new Set([answer]);
  while(set.size < Math.min(optionCount, pool.length)){
    set.add(pick(pool));
  }
  return shuffle([...set]);
}

function buildQuestion(){
  const d = state.difficulty;
  const m = state.mode;

  if(m==="Story"){
    const page = STORY[state.storyIndex % STORY.length];
    const q = page.q;
    const options = buildOptions(q.type, q.answer, d);
    return {mode:m, type:q.type, prompt:q.prompt, answer:q.answer, meta:{story:page}, options};
  }

  if(m==="Memory"){
    return {mode:m, type:"memory", prompt:"Find all the matching pairs!", answer:null, options:[], meta:{}};
  }

  if(m==="Math"){
    const max = (d===1)?5:(d===2)?7:9;
    const count = rand(max)+1;
    const options = buildOptions("number", count, d);
    return {mode:m, type:"math", prompt:"Count the dots and tap the number", answer:count, options, meta:{count}};
  }

  if(m==="Phonics"){
    const item = pick(PHONICS);
    const options = buildOptions("phonics", item.letter, d);
    return {mode:m, type:"phonics", prompt:`Tap the letter that makes the '${item.sound}' sound`, answer:item.letter, options, meta:{sound:item.sound}};
  }

  if(m==="Letters"){
    const pool = LETTERS.slice(0, d===1?8:d===2?14:26);
    const ans = pick(pool);
    return {mode:m, type:"letter", prompt:"Tap the letter", answer:ans, options: buildOptions("letter", ans, d), meta:{}};
  }

  if(m==="Numbers"){
    const max = d===1?5:d===2?7:9;
    const ans = rand(max)+1;
    return {mode:m, type:"number", prompt:"Tap the number", answer:ans, options: buildOptions("number", ans, d), meta:{}};
  }

  if(m==="Colors"){
    const pool = COLORS.slice(0, d===1?4:d===2?5:6);
    const ans = pick(pool);
    return {mode:m, type:"color", prompt:"Tap the color", answer:ans, options: buildOptions("color", ans, d), meta:{}};
  }

  // Shapes default
  const pool = SHAPES.slice(0, d===1?3:d===2?4:5);
  const ans = pick(pool);
  return {mode:m, type:"shape", prompt:"Tap the shape", answer:ans, options: buildOptions("shape", ans, d), meta:{}};
}

/* ---- Memory Game ---- */
function memoryDeck(difficulty){
  const pairCount = difficulty===1?3:difficulty===2?4:5;
  const pool = ["üê∂","üê±","üêª","ü¶ä","üêº","üê∏","ü¶Å","üê∞","üêµ","üêØ"];
  const picks = shuffle(pool).slice(0,pairCount);
  const deck = shuffle([...picks,...picks]).map((v,i)=>({id:i,v}));
  return deck;
}

/* ---- Adaptive difficulty ---- */
function adapt(isCorrect){
  if(isCorrect){
    state.streak += 1;
    if(state.streak >= 3){
      state.difficulty = clamp(state.difficulty+1,1,3);
      state.streak = 0;
    }
  }else{
    state.streak = 0;
    state.difficulty = clamp(state.difficulty-1,1,3);
  }
  state.progress.difficulty = state.difficulty;
  saveProgress();
}

/* ---- Confetti ---- */
function confetti(){
  const el = document.getElementById("confetti");
  el.innerHTML = "";
  el.classList.remove("hidden");
  for(let i=0;i<24;i++){
    const p = document.createElement("i");
    p.style.setProperty("--x", ((Math.random()-0.5)*520).toFixed(0)+"px");
    p.style.setProperty("--y", ((Math.random()-0.5)*520).toFixed(0)+"px");
    p.style.left = "50%";
    p.style.top = "50%";
    el.appendChild(p);
  }
  setTimeout(()=>el.classList.add("hidden"), 900);
}

/* =======================
   Render
   ======================= */
let currentQ = null;
let mem = null;

function render(){
  const s = state.screen;

  if(s==="welcome"){
    app.innerHTML = `
      <div class="center">
        <div class="mascot" style="margin:0 auto 10px;">üê∂</div>
        <div class="title">Skeine Kids Learning</div>
        <div class="sub">Fun learning game for ages <b>3‚Äì5</b></div>
      </div>

      <div style="height:12px"></div>

      <div class="grid grid2">
        <div class="panel">
          <div class="sub">Quick Rounds</div>
          <div style="font-weight:900;font-size:20px">3 per game</div>
        </div>
        <div class="panel">
          <div class="sub">Adaptive</div>
          <div style="font-weight:900;font-size:20px">Level ${state.difficulty}</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="grid">
        <button id="start">Start</button>
        <button class="secondary" id="parent">Parent Dashboard</button>
      </div>

      <div class="tiny center" style="margin-top:10px">Tip: Tap anywhere once to enable sound on some phones.</div>
    `;
    bindWelcome();
    return;
  }

  if(s==="player"){
    app.innerHTML = topBar() + `
      <div class="title">Choose your player</div>
      <div class="sub">Tap a name to begin.</div>
      <div style="height:12px"></div>

      <div class="grid grid2">
        <button class="big" id="jayce">üë¶ Jayce</button>
        <button class="big" id="jayde">üëß Jayde</button>
      </div>

      <div style="height:12px"></div>
      <button class="secondary" id="back">Back</button>
    `;
    bindPlayer();
    return;
  }

  if(s==="mode"){
    app.innerHTML = topBar() + `
      <div class="title">Choose a game</div>
      <div class="sub">Pick a learning mode. Each game is 3 quick rounds.</div>
      <div style="height:12px"></div>

      <div class="grid grid4">
        ${MODES.map(m=>`<button class="${m===state.mode?'':'secondary'}" data-mode="${m}">${m}</button>`).join("")}
      </div>

      <div style="height:12px"></div>

      <div class="grid grid2">
        <div class="panel">
          <div class="sub">Difficulty</div>
          <div style="font-weight:900;font-size:22px">Level ${state.difficulty}</div>
          <div class="tiny">Gets harder as kids get better.</div>
        </div>
        <div class="panel">
          <div class="sub">Best Streak</div>
          <div style="font-weight:900;font-size:22px">${state.progress.bestStreak}</div>
          <div class="tiny">Saved on this device.</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="grid">
        <button id="play">Play ${state.mode}</button>
        <button class="secondary" id="change">Change Player</button>
      </div>
    `;
    bindMode();
    return;
  }

  if(s==="game"){
    if(!currentQ) currentQ = buildQuestion();

    let storyBlock = "";
    if(state.mode==="Story"){
      const p = currentQ.meta.story;
      storyBlock = `
        <div class="panel">
          <div class="sub">Story</div>
          <div style="font-weight:900;font-size:20px">${p.title}</div>
          <div class="sub" style="margin-top:6px">${p.text}</div>
          <div style="margin-top:10px" class="prompt">${currentQ.prompt}</div>
        </div>
      `;
    } else {
      storyBlock = `
        <div class="panel">
          <div class="sub">Buddy says:</div>
          <div class="prompt">${currentQ.prompt}</div>
          ${state.mode==="Phonics" ? `<div class="tiny">Sound: ‚Äú${currentQ.meta.sound}‚Äù</div>` : ``}
        </div>
      `;
    }

    let extra = "";
    if(state.mode==="Math"){
      extra = `
        <div class="panel">
          <div class="sub">Count the dots</div>
          <div class="dots" style="margin-top:10px">
            ${Array.from({length: currentQ.meta.count}).map(()=>`<div class="dot"></div>`).join("")}
          </div>
        </div>
      `;
    }

    let body = "";
    if(state.mode==="Memory"){
      if(!mem) mem = { deck: memoryDeck(state.difficulty), flipped: [], matched: new Set(), lock:false };
      body = renderMemory();
    } else {
      body = `
        <div class="grid grid4">
          ${currentQ.options.map(o=>`<button class="choice" data-choice="${String(o)}">${String(o)}</button>`).join("")}
        </div>
      `;
    }

    const toast = state.feedback ? `<div class="toast ${state.feedback.ok?'':'bad'}">${state.feedback.msg}</div>` : "";

    app.innerHTML = topBar() + `
      <div class="row">
        <div class="pill"><b>Mode:</b> ${state.mode}</div>
        <div class="pill"><b>Round:</b> ${state.round}/3</div>
        <div class="pill"><b>Level:</b> ${state.difficulty}</div>
      </div>

      <div style="height:12px"></div>
      ${storyBlock}
      <div style="height:12px"></div>
      ${extra}
      ${state.mode==="Math" ? `<div style="height:12px"></div>` : ``}

      ${body}
      ${toast}

      <div class="row" style="margin-top:12px">
        <div class="sub">Score: <b>${state.score}</b> / 3</div>
        <div class="stars">${renderStars(state.stars)}</div>
      </div>
    `;

    bindGame();
    return;
  }

  if(s==="winner"){
    const perfect = state.score===3;
    app.innerHTML = topBar() + `
      <div class="center">
        <div class="title">${perfect ? "üéâ PERFECT GAME! üéâ" : "üéâ Great Job! üéâ"}</div>
        <div style="height:10px"></div>
        <div class="mascot" style="margin:0 auto 10px">${perfect ? "üèÜ" : "‚≠ê"}</div>
        <div style="font-size:18px">${state.player} scored <b>${state.score}</b> out of <b>3</b></div>
        <div style="height:8px"></div>
        <div class="stars">${renderStars(state.stars)}</div>
      </div>

      <div style="height:12px"></div>

      <div class="panel center">
        <div class="sub">Today‚Äôs Reward</div>
        <div style="font-weight:900;font-size:20px;margin-top:6px">
          ${perfect ? "Golden Star Sticker ‚ú®" : (state.stars>=2 ? "Super Star Sticker ‚≠ê" : "Brave Try Sticker üíõ")}
        </div>
        <div class="tiny" style="margin-top:8px">(We can add a real sticker gallery next.)</div>
      </div>

      <div style="height:12px"></div>

      <div class="grid">
        <button id="again">Play Again</button>
        <button class="secondary" id="parent">Parent Dashboard</button>
      </div>
    `;
    bindWinner();
    return;
  }
}

function topBar(){
  const v = state.voiceOn ? "On" : "Off";
  return `
    <div class="row" style="margin-bottom:12px">
      <div class="bar">
        <div class="mascot">üê∂</div>
        <div>
          <div class="tiny">Player</div>
          <div style="font-weight:900;font-size:18px">${state.player || "‚Äî"}</div>
        </div>
      </div>
      <div class="bar">
        <button class="secondary" id="parent">Parent</button>
        <button class="secondary" id="voice">Voice: ${v}</button>
      </div>
    </div>
  `;
}
function renderStars(n){
  return [0,1,2].map(i=>`<span style="opacity:${i<n?1:.3}">‚≠ê</span>`).join("");
}

/* =======================
   Binds
   ======================= */
function bindWelcome(){
  document.getElementById("start").onclick = ()=>{
    SFX.pop(); speak("Welcome! Let's choose a player.");
    state.screen="player"; render();
  };
  document.getElementById("parent").onclick = ()=> openParent();
}

function bindPlayer(){
  document.getElementById("jayce").onclick = ()=>{
    SFX.pop(); state.player="Jayce"; speak("Hi Jayce! Let's choose a learning game.");
    state.screen="mode"; render();
  };
  document.getElementById("jayde").onclick = ()=>{
    SFX.pop(); state.player="Jayde"; speak("Hi Jayde! Let's choose a learning game.");
    state.screen="mode"; render();
  };
  document.getElementById("back").onclick = ()=>{ state.screen="welcome"; render(); };
  document.getElementById("parent").onclick = ()=> openParent();
  document.getElementById("voice").onclick = toggleVoice;
}

function bindMode(){
  [...app.querySelectorAll("[data-mode]")].forEach(btn=>{
    btn.onclick = ()=>{
      SFX.pop(); state.mode = btn.dataset.mode;
      speak(state.mode + " mode.");
      render();
    };
  });
  document.getElementById("play").onclick = ()=>{
    SFX.pop(); speak("Let's play!");
    startGame();
  };
  document.getElementById("change").onclick = ()=>{ state.screen="player"; render(); };
  document.getElementById("parent").onclick = ()=> openParent();
  document.getElementById("voice").onclick = toggleVoice;
}

function startGame(){
  state.round=1; state.score=0; state.stars=0; state.feedback=null; state.storyIndex=0; state.streak=0;
  currentQ = null; mem = null;
  state.screen="game";
  render();
  // speak first prompt after render
  setTimeout(()=>{
    if(state.mode==="Memory"){
      speak("Find the matching pairs!");
    }else if(state.mode==="Story"){
      const p = STORY[state.storyIndex % STORY.length];
      speak(`${state.player}, story time! ${p.title}. ${p.text}. ${currentQ.prompt}.`);
    }else{
      speak(`${state.player}, ${currentQ.prompt}`);
    }
  }, 30);
}

function bindGame(){
  document.getElementById("parent").onclick = ()=> openParent();
  document.getElementById("voice").onclick = toggleVoice;

  if(state.mode==="Memory"){
    bindMemory();
    return;
  }

  [...app.querySelectorAll("[data-choice]")].forEach(btn=>{
    btn.onclick = ()=> handleChoice(btn.dataset.choice);
  });
}

function handleChoice(raw){
  if(!currentQ) return;
  const choice = parseChoice(raw, currentQ.answer);
  const ok = (choice === currentQ.answer);

  state.feedback = ok ? {ok:true,msg:"Yes! Great job!"} : {ok:false,msg:"Almost! Next one!"};
  if(ok){ SFX.success(); speak("Great job!"); }
  else { SFX.fail(); speak("Good try! Let's keep going."); }

  render();

  setTimeout(()=>{
    state.feedback = null;
    completeRound(ok);
  }, 520);
}

function parseChoice(raw, answer){
  // convert to number if answer is a number
  if(typeof answer === "number") return Number(raw);
  return raw;
}

function completeRound(ok){
  if(ok){ state.score += 1; state.stars = clamp(state.stars+1,0,3); }
  adapt(ok);

  if(state.round >= 3){
    finishGame();
    return;
  }
  state.round += 1;
  if(state.mode==="Story") state.storyIndex += 1;

  currentQ = null; mem = null;
  render();

  setTimeout(()=>{
    if(state.mode==="Memory"){
      speak("Find the matching pairs!");
    }else if(state.mode==="Story"){
      const p = STORY[state.storyIndex % STORY.length];
      speak(`${state.player}, ${p.title}. ${p.text}. ${currentQ.prompt}.`);
    }else{
      speak(`${state.player}, ${currentQ.prompt}`);
    }
  }, 30);
}

function finishGame(){
  const perfect = state.score===3;

  // update progress
  state.progress.totalGames += 1;
  state.progress.totalStars += state.stars;
  state.progress.bestStreak = Math.max(state.progress.bestStreak, state.streak);
  if(perfect){
    state.progress.modeWins[state.mode] = (state.progress.modeWins[state.mode]||0) + 1;
  }
  saveProgress();

  if(perfect){
    confetti();
    SFX.success();
    speak("Perfect game! Amazing!");
  }else{
    speak("Great playing!");
  }

  state.screen="winner";
  render();
}

function bindWinner(){
  document.getElementById("again").onclick = ()=>{
    // restart ONLY here
    SFX.pop();
    state.screen="mode";
    render();
  };
  document.getElementById("parent").onclick = ()=> openParent();
  document.getElementById("voice").onclick = toggleVoice;
}

function toggleVoice(){
  state.voiceOn = !state.voiceOn;
  SFX.pop();
  render();
}

/* =======================
   Parent Dashboard (modal)
   ======================= */
function openParent(){
  SFX.pop();
  const p = state.progress;
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.innerHTML = `
    <div class="card" style="width:min(860px,100%);">
      <div class="row">
        <div class="title" style="font-size:22px">Parent Dashboard</div>
        <button class="secondary" id="close">Close</button>
      </div>

      <div style="height:12px"></div>

      <div class="grid grid2">
        <div class="panel"><div class="sub">Total Games</div><div style="font-weight:900;font-size:24px">${p.totalGames}</div></div>
        <div class="panel"><div class="sub">Best Streak</div><div style="font-weight:900;font-size:24px">${p.bestStreak}</div></div>
        <div class="panel"><div class="sub">Stars Earned</div><div style="font-weight:900;font-size:24px">${p.totalStars}</div></div>
        <div class="panel"><div class="sub">Difficulty</div><div style="font-weight:900;font-size:24px">Level ${p.difficulty}</div></div>
      </div>

      <div style="height:12px"></div>

      <div class="panel">
        <div class="sub" style="margin-bottom:10px">Mode Wins (Perfect games)</div>
        <div class="grid grid2">
          ${Object.entries(p.modeWins).map(([k,v])=>`
            <div class="panel" style="background:rgba(255,255,255,.7);">
              <div style="font-weight:900">${k}</div>
              <div class="sub">${v}</div>
            </div>
          `).join("")}
        </div>
      </div>

      <div class="tiny" style="margin-top:10px">Saved on this device only.</div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector("#close").onclick = ()=> modal.remove();
  modal.onclick = (e)=>{ if(e.target===modal) modal.remove(); };
}

/* =======================
   Memory render/bind
   ======================= */
function renderMemory(){
  const m = mem;
  const matches = m.matched.size/2;
  const totalPairs = m.deck.length/2;

  const cards = m.deck.map(c=>{
    const isUp = m.flipped.includes(c.id) || m.matched.has(c.id);
    return `<button class="choice" style="height:64px;font-size:26px" data-mem="${c.id}">${isUp ? c.v : "‚ùì"}</button>`;
  }).join("");

  return `
    <div class="panel">
      <div class="sub">Memory</div>
      <div class="prompt">Find the matching pairs!</div>
      <div class="tiny">Matches: ${matches} / ${totalPairs}</div>
    </div>
    <div style="height:12px"></div>
    <div class="grid grid4">${cards}</div>
  `;
}

function bindMemory(){
  [...app.querySelectorAll("[data-mem]")].forEach(btn=>{
    btn.onclick = ()=> flipMemory(Number(btn.dataset.mem));
  });
}

function flipMemory(id){
  const m = mem;
  if(m.lock) return;
  if(m.matched.has(id)) return;
  if(m.flipped.includes(id)) return;

  SFX.pop();
  m.flipped.push(id);
  render();

  if(m.flipped.length===2){
    m.lock = true;
    const [a,b] = m.flipped;
    const ca = m.deck.find(x=>x.id===a);
    const cb = m.deck.find(x=>x.id===b);
    if(ca.v === cb.v){
      SFX.success(); speak("Nice match!");
      m.matched.add(a); m.matched.add(b);
      setTimeout(()=>{
        m.flipped = [];
        m.lock = false;
        // complete if done
        if(m.matched.size === m.deck.length){
          speak("You did it!");
          state.feedback = {ok:true,msg:"Pairs completed!"};
          render();
          setTimeout(()=>{
            state.feedback = null;
            completeRound(true);
          }, 380);
        }else{
          render();
        }
      }, 420);
    }else{
      SFX.fail(); speak("Oops! Try again.");
      setTimeout(()=>{
        m.flipped = [];
        m.lock = false;
        render();
      }, 620);
    }
  }
}

/* =======================
   Boot
   ======================= */
window.addEventListener("click", ()=>{ ensureAudio(); }, {once:true});

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(()=>{});
}

render();
</script>
</body>
</html>
